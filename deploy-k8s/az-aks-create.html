
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deploy the Kubernetes cluster &#8212; Hub23 Deployment Guide</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.5f77b4aec8189eecf79907ce328c390d.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Upgrading the Kubernetes cluster" href="upgrade.html" />
    <link rel="prev" title="Enable Network Policies" href="network-policies.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      <h1 class="site-logo" id="site-title">Hub23 Deployment Guide</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Hub23 Deployment Guide
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../azure-prereqs/index.html">
   Azure Resources
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../azure-prereqs/resource-group/index.html">
     Getting Started on Azure
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/resource-group/install.html">
       Installation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/resource-group/create-resource-group.html">
       Create the Resource Group
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../azure-prereqs/key-vault/index.html">
     Azure Key Vault
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/key-vault/install.html">
       Installation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/key-vault/create-key-vault.html">
       Create the Key Vault
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/key-vault/add-secrets.html">
       Adding secrets to the Key Vault
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/key-vault/download-secrets.html">
       Downloading Secrets from the Key Vault
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/key-vault/service-principals.html">
       Service Principal
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../azure-prereqs/container-registry/index.html">
     Azure Container Registry
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/container-registry/install.html">
       Installation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../azure-prereqs/container-registry/create-acr.html">
       Create an Azure Container Registry
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Deploy a Kubernetes Cluster with AKS
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="install.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="download-secrets.html">
     Download the required secrets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="network-policies.html">
     Enable Network Policies
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Deploy the Kubernetes cluster
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="upgrade.html">
     Upgrading the Kubernetes cluster
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="refs.html">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../setup-helm/index.html">
   Setup Helm
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../setup-helm/install.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../setup-helm/setup-helm.html">
     Setting up Helm
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../cert-manager/index.html">
   Enabling HTTPS using
   <code class="docutils literal notranslate">
    <span class="pre">
     cert-manager
    </span>
   </code>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../cert-manager/install.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../cert-manager/context.html">
     Context
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../cert-manager/create-files.html">
     Creating files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../cert-manager/deployment.html">
     Deploying
     <code class="docutils literal notranslate">
      <span class="pre">
       cert-manager
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../cert-manager/refs.html">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../binderhub/index.html">
   Installing BinderHub
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../binderhub/install.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../binderhub/installing-binderhub.html">
     Installing BinderHub directly from the Helm Chart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../binderhub/installing-binderhub-local-helm-chart.html">
     Installing BinderHub with a Local Helm Chart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../binderhub/connect-container-registry.html">
     Connect a Container Registry
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../binderhub/github-api-limit.html">
     Increasing GitHub API limit
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../customising/index.html">
   Customising your Deployment
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../customising/changing-logo.html">
     Changing the logo on the Binder page
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../customising/customise-jupyterhub.html">
     Customising User Resources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../customising/refs.html">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../advanced/index.html">
   Advanced Configurations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/enabling-authentication.html">
     Enabling Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/enabling-page-redirection.html">
     Enabling Page Redirection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/optimising-jupyterhub.html">
     Optimising the JupyterHub
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/refs.html">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tearing-down/index.html">
   Tearing Down BinderHub
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tearing-down/install.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tearing-down/teardown.html">
     Tearing down your Deployment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tearing-down/refs.html">
     References
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/deploy-k8s/az-aks-create.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-a-kubernetes-version">
   Finding a Kubernetes version
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-aks-cluster">
   Create the AKS cluster
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enable-autoscaling">
     Enable Autoscaling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-multiple-nodepools">
     Create multiple nodepools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#delete-local-copies-of-the-secret-files">
     Delete local copies of the secret files
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-credentials-for-kubectl">
   Get credentials for
   <code class="docutils literal notranslate">
    <span class="pre">
     kubectl
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-the-cluster-is-fully-functional">
   Check the cluster is fully functional
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="deploy-the-kubernetes-cluster">
<span id="content-k8s-create"></span><h1>Deploy the Kubernetes cluster<a class="headerlink" href="#deploy-the-kubernetes-cluster" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since Hub23 now shares the same Kubernetes infrastructure as the Turing Federation BinderHub, the following docs are only here for clarity and should not be acted upon without first notifying the mybinder.org operating team and removing the Turing’s BinderHub from the Federation.</p>
</div>
<div class="section" id="finding-a-kubernetes-version">
<span id="content-k8s-version"></span><h2>Finding a Kubernetes version<a class="headerlink" href="#finding-a-kubernetes-version" title="Permalink to this headline">¶</a></h2>
<p>First, find a reasonably up-to-date version of Kubernetes to install onto the cluster.
This can be done with the below command which will output a table as demonstrated.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ az aks get-versions -l westeurope -o table
KubernetesVersion    Upgrades
-------------------  -------------------------
<span class="m">1</span>.20.2<span class="o">(</span>preview<span class="o">)</span>      None available
<span class="m">1</span>.19.7               <span class="m">1</span>.20.2<span class="o">(</span>preview<span class="o">)</span>
<span class="m">1</span>.19.6               <span class="m">1</span>.19.7, <span class="m">1</span>.20.2<span class="o">(</span>preview<span class="o">)</span>
<span class="m">1</span>.18.14              <span class="m">1</span>.19.6, <span class="m">1</span>.19.7
<span class="m">1</span>.18.10              <span class="m">1</span>.18.14, <span class="m">1</span>.19.6, <span class="m">1</span>.19.7
<span class="m">1</span>.17.16              <span class="m">1</span>.18.10, <span class="m">1</span>.18.14
<span class="m">1</span>.17.13              <span class="m">1</span>.17.16, <span class="m">1</span>.18.10, <span class="m">1</span>.18.14
</pre></div>
</div>
<p>It is recommended to pick a version number that has at least one upgrade version available that is <strong>not</strong> in preview, so we can be sure that any bugs are likely to have been found and fixed.
This would be <code class="docutils literal notranslate"><span class="pre">1.19.6</span></code> based on the above example.</p>
</div>
<div class="section" id="create-the-aks-cluster">
<h2>Create the AKS cluster<a class="headerlink" href="#create-the-aks-cluster" title="Permalink to this headline">¶</a></h2>
<p>The following command will deploy a Kubernetes cluster into the Hub23 resource group.
This command has been known to take between 7 and 30 minutes to execute depending on resource availability in the location we set when creating the resource group.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az aks create <span class="se">\</span>
    --name hub23cluster <span class="se">\</span>
    --resource-group hub23 <span class="se">\</span>
    --kubernetes-version VERSION <span class="se">\</span>
    --ssh-key-value .secret/ssh-key-hub23cluster.pub <span class="se">\</span>
    --node-count <span class="m">3</span> <span class="se">\</span>
    --node-vm-size Standard_D2s_v3 <span class="se">\</span>
    --service-principal <span class="k">$(</span>cat .secret/appId.txt<span class="k">)</span> <span class="se">\</span>
    --client-secret <span class="k">$(</span>cat .secret/appKey.txt<span class="k">)</span> <span class="se">\</span>
    --dns-service-ip <span class="m">10</span>.0.0.10 <span class="se">\</span>
    --docker-bridge-address <span class="m">172</span>.17.0.1/16 <span class="se">\</span>
    --network-plugin kubenet <span class="se">\</span>
    --network-policy calico <span class="se">\</span>
    --max-pods <span class="m">110</span> <span class="se">\</span>
    --service-cidr <span class="m">10</span>.0.0.0/16 <span class="se">\</span>
    --vnet-subnet-id <span class="si">${</span><span class="nv">SUBNET_ID</span><span class="si">}</span> <span class="se">\</span>
    --output table
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--kubernetes-version</span></code>: It’s recommended to use the most up-to-date version of Kubernetes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--node-count</span></code> is the number of nodes to be deployed. 3 is recommended for a stable, scalable cluster.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--node-vm-size</span></code> denotes the type of virtual machine to be deployed. A list of Linux types can be found <a class="reference external" href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/linux/">here</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--dns-service-ip</span></code>: An IP address assigned to the Kubernetes DNS service.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--docker-bridge-address</span></code>: A specific IP address and netmask for the Docker bridge, using standard CIDR notation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--network-plugin</span></code>: The Kubernetes network plugin to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--network-policy</span></code>: The Kubernetes network policy to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-pods</span></code>: The maximum number of pods per node.
The Kubernetes API seems to struggle above 110 pods.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--service-cidr</span></code>: A CIDR notation IP range from which to assign service cluster IPs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--vnet-subnet-id</span></code>: The ID of a subnet in an existing VNet into which to deploy the cluster.</p></li>
</ul>
<div class="section" id="enable-autoscaling">
<span id="content-az-aks-create-autoscale"></span><h3>Enable Autoscaling<a class="headerlink" href="#enable-autoscaling" title="Permalink to this headline">¶</a></h3>
<p>To enable autoscaling on the cluster, add the following flags to the above <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--enable-cluster-autoscaler
--min-count MINIMUM_NUMBER_OF_NODES
--max-count MAXIMUM_NUMBER_OF_NODES
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--enable-cluster-autoscaler</span></code> enables the Kubernetes autoscaler</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--min-count</span></code>/<code class="docutils literal notranslate"><span class="pre">--max-count</span></code> defines the minimum and maximum number of nodes to be spun up/down</p></li>
</ul>
</div>
<div class="section" id="create-multiple-nodepools">
<span id="content-az-aks-create-nodepools"></span><h3>Create multiple nodepools<a class="headerlink" href="#create-multiple-nodepools" title="Permalink to this headline">¶</a></h3>
<p>To create multiple nodepools within your Kubernetes cluster, add the following flags to the above <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--nodepool-name <span class="o">{</span> core <span class="p">|</span> user <span class="o">}</span>
--nodepool-labels hub.jupyter.org/node-purpose<span class="o">={</span> core <span class="p">|</span> user <span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--nodepool-name</span></code> assigns a name to your new nodepool</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--nodepool-labels</span></code> allows the definition of labels that will propagate to all nodes within the nodepool</p></li>
</ul>
<p>It is recommended to use iether <code class="docutils literal notranslate"><span class="pre">core</span></code> or <code class="docutils literal notranslate"><span class="pre">user</span></code> to name/label these nodepools as BinderHub will try to schedule pods according to these labels.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The first nodepool create (i.e. with <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span></code> command) cannot be deleted as it contains the <code class="docutils literal notranslate"><span class="pre">kubeadmin</span></code> kubelet.</p>
</div>
<p>Another nodepool can then be added as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az aks nodepool add <span class="se">\</span>
    --cluster-name hub23cluster <span class="se">\</span>
    --name user <span class="se">\</span>
    --resource-group hub23 <span class="se">\</span>
    --kubernetes-version VERSION <span class="se">\</span>
    --max-pods <span class="m">110</span> <span class="se">\</span>
    --node-count <span class="m">3</span> <span class="se">\</span>
    --node-vm-size Standard_D2s_v3 <span class="se">\</span>
    --vnet-subnet-id <span class="si">${</span><span class="nv">SUBNET_ID</span><span class="si">}</span> <span class="se">\</span>
    --labels hub.jupyter.org/node-purpose<span class="o">=</span>user <span class="se">\</span>
    --output table
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/aks/nodepool?view=azure-cli-latest"><code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">nodepool</span></code> docs</a> for more info and commands.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The flags to enable autoscaling can also be used here.</p>
</div>
</div>
<div class="section" id="delete-local-copies-of-the-secret-files">
<h3>Delete local copies of the secret files<a class="headerlink" href="#delete-local-copies-of-the-secret-files" title="Permalink to this headline">¶</a></h3>
<p>Once the Kubernetes cluster is deployed, you should delete the local copy of the Service Principal and public SSH key.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm .secret/ssh-key-hub23cluster.pub
rm .secret/appId.txt
rm .secret/appKey.txt
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-credentials-for-kubectl">
<h2>Get credentials for <code class="docutils literal notranslate"><span class="pre">kubectl</span></code><a class="headerlink" href="#get-credentials-for-kubectl" title="Permalink to this headline">¶</a></h2>
<p>We need to configure the local installation of the Kubernetes CLI to work with the version deployed onto the cluster, and do so with the following command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az aks get-credentials --name hub23cluster --resource-group hub23
</pre></div>
</div>
<p>This command would need to be repeated when trying to manage the cluster from another computer or if you have been working with a different cluster.</p>
</div>
<div class="section" id="check-the-cluster-is-fully-functional">
<h2>Check the cluster is fully functional<a class="headerlink" href="#check-the-cluster-is-fully-functional" title="Permalink to this headline">¶</a></h2>
<p>Output the status of the nodes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get nodes
</pre></div>
</div>
<p>All nodes should have <code class="docutils literal notranslate"><span class="pre">STATUS</span></code> as <code class="docutils literal notranslate"><span class="pre">Ready</span></code>.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./deploy-k8s"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="network-policies.html" title="previous page">Enable Network Policies</a>
    <a class='right-next' id="next-link" href="upgrade.html" title="next page">Upgrading the Kubernetes cluster</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Sarah Gibson<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>