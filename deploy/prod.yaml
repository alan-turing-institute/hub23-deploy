projectName: hub23

binderhub:
  config:
    BinderHub:
      image_prefix: hub23registry.azurecr.io/hub23/binder-dev-
      hub_url: https://hub.hub23.turing.ac.uk
      use_named_servers: true

    DockerRegistry:
      token_url: https://hub23registry.azurecr.io/oauth2/token?service=hub23registry.azurecr.io

  registry:
    url: https://hub23registry.azurecr.io

  jupyterhub:
    cull:
      every: 660
      timeout: 600
      maxAge: 21600  # maxAge is 6 hours: 6 * 3600 = 21600

    hub:
      allowNamedServers: true

      services:
        binder:
          oauth_redirect_uri: "https://binder.hub23.turing.ac.uk/oauth_callback"
          oauth_client_id: "binder-oauth-client-test"
      extraConfig:
        hub_extra: |
          c.JupyterHub.redirect_to_server = False
        binder: |
          from kubespawner import KubeSpawner
          class BinderSpawner(KubeSpawner):
            def start(self):
              if 'image' in self.user_options:
                # binder service sets the image spec via user options
                self.image = self.user_options['image']
              return super().start()
          c.JupyterHub.spawner_class = BinderSpawner

    singleuser:
      cmd: jupyterhub-singleuser
      memory:
        limit: 1G
        guarantee: 1G
      cpu:
        limit: .5
        guarantee: .5

    prePuller:
      continuous:
        enabled: true

    scheduling:
      podPriority:
        enabled: true
      userPlaceholder:
        replicas: 3
      userScheduler:
        enabled: true
      corePods:
        nodeAffinity:
          matchNodePurpose: require
      userPods:
        nodeAffinity:
          matchNodePurpose: prefer

    auth:
      type: github
      github:
        callbackUrl: "https://hub.hub23.turing.ac.uk/hub/oauth_callback"
        orgWhitelist:
          - "binderhub-test-org"
      scopes:
        - "read:user"

cert-manager:
  ingressShim:
    defaultIssuerName: "prod"

prometheus:
  server:
    retention: 30d
    ingress:
      hosts:
        - prometheus.hub23.turing.ac.uk
      tls:
        - hosts:
            - prometheus.hub23.turing.ac.uk
          secretName: certmanager-tls-prometheus
