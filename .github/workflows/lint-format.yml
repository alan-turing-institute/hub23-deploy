name: Lint and Format

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  format-python-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Setup Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Install black
        run: |
          python -m pip install -U pip
          python -m pip install black==19.3b0

      - name: Check formatting
        run: |
          black --check .

  lint-python-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Setup Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Install flake8
        run: |
          python -m pip install -U pip
          python -m pip install flake8==3.7.8

      - name: Check linting
        run: |
          flake8 --ignore=E501,W503,F821 .

  lint-validate-helm-chart:
    runs-on: ubuntu-latest

    steps:
      # TODO: Add yamllint
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Run Kubernetes tools
        uses: stefanprodan/kube-tools@v1.5.0
        with:
          helmv3: 3.5.2
          command: |
            echo "#### Setup: Add helm charts"
            helmv3 repo add jupyterhub https://jupyterhub.github.io/helm-chart
            helmv3 repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
            helmv3 repo update
            echo "#### Setup: Update local chart"
            cd hub23-chart && helmv3 dep up && cd ..
            echo "#### TEST 1: Run helm lint"
            helmv3 lint hub23-chart \
              -f hub23-chart/values.yaml \
              -f deploy/prod.yaml \
              -f deploy/test-values.yaml \
              --debug
            echo "#### TEST 2: Run helm template and pipe to kubeval"
            helmv3 template hub23-chart \
              -f hub23-chart/values.yaml \
              -f deploy/prod.yaml \
              -f deploy/test-values.yaml \
              --debug | kubeval \
              --kubernetes-version 1.18.1 \
              --ignore-missing-schema
